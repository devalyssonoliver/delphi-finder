unit SearchMore;

interface

uses
  System.SysUtils, System.Classes, Vcl.Controls, Vcl.StdCtrls, Vcl.ExtCtrls,
  Vcl.StyledButton, Vcl.Forms, Data.DB, Vcl.Graphics;

type
  TSearchMore = class(TStyledSpeedButton)
  private
    FPanel: TPanel;
    FCriterioComboBox: TComboBox;
    FEditPesquisa: TEdit;
    FDataSource: TDataSource;
    FCriterios: TStringList;
    procedure SetDataSource(Value: TDataSource);
    procedure SetCriterios(Value: TStringList);
    procedure BotaoClick(Sender: TObject);
    procedure EditChange(Sender: TObject);
    procedure AplicarFiltro;
  public
    constructor Create(AOwner: TComponent); override;
    destructor Destroy; override;
  published
    property DataSource: TDataSource read FDataSource write SetDataSource;
    property Criterios: TStringList read FCriterios write SetCriterios;
  end;

procedure Register;

implementation

procedure Register;
begin
  RegisterComponents('ZFery', [TSearchMore]);
end;

{ TSearchMore }

constructor TSearchMore.Create(AOwner: TComponent);
begin
  inherited Create(AOwner);

  FCriterios := TStringList.Create;

  // Painel de Pesquisa
  FPanel := TPanel.Create(Self);
  FPanel.Parent := nil; // O Parent será definido apenas quando necessário
  FPanel.Visible := False;
  FPanel.BevelOuter := bvNone;
  FPanel.SetBounds(Left, Top + Height, 200, 80);

  // ComboBox para Critérios
  FCriterioComboBox := TComboBox.Create(FPanel);
  FCriterioComboBox.Parent := FPanel;
  FCriterioComboBox.SetBounds(10, 10, 180, 25);

  // Edit para pesquisa
  FEditPesquisa := TEdit.Create(FPanel);
  FEditPesquisa.Parent := FPanel;
  FEditPesquisa.SetBounds(10, 40, 180, 25);
  FEditPesquisa.OnChange := EditChange;

  // Configuração do botão
  Caption := '🔍';
  OnClick := BotaoClick;
end;

destructor TSearchMore.Destroy;
begin
  FCriterios.Free;
  inherited Destroy;
end;

procedure TSearchMore.SetDataSource(Value: TDataSource);
begin
  FDataSource := Value;
end;

procedure TSearchMore.SetCriterios(Value: TStringList);
begin
  FCriterios.Assign(Value);
  FCriterioComboBox.Items.Assign(FCriterios);
end;

procedure TSearchMore.BotaoClick(Sender: TObject);
begin
  // Definir o Parent apenas quando o painel for aberto
  if FPanel.Parent = nil then
  begin
    if Assigned(Self.Parent) then
      FPanel.Parent := Self.Parent
    else
      raise Exception.Create('O componente TSearchMore precisa estar dentro de um container válido.');
  end;

  // Alterna a visibilidade do painel de pesquisa
  FPanel.Visible := not FPanel.Visible;
end;

procedure TSearchMore.EditChange(Sender: TObject);
begin
  AplicarFiltro;
end;

procedure TSearchMore.AplicarFiltro;
var
  Campo, Filtro: string;
begin
  if Assigned(FDataSource) and Assigned(FDataSource.DataSet) then
  begin
    Campo := FCriterioComboBox.Text;
    Filtro := FEditPesquisa.Text;

    if (Campo <> '') and (Filtro <> '') then
    begin
      FDataSource.DataSet.Filter := Format('%s LIKE ''%%%s%%''', [Campo, Filtro]);
      FDataSource.DataSet.Filtered := True;
    end
    else
    begin
      FDataSource.DataSet.Filtered := False;
    end;
  end;
end;

end.

